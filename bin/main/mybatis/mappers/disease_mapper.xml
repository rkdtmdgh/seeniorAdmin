<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.see_nior.seeniorAdmin.disease.mapper.DiseaseMapper">

	<resultMap type="DiseaseCategoryDto" id="DiseaseCategoryDto">
		<result column="no" property="no" />
		<result column="name" property="name" />
		
		<!-- 임의로 추가된 필드. 직렬화나 역직렬화 시에는 무시하게 설정하였음 -->
		<result column="dc_name" property="dc_name" />
		<!--  -->
		
		<result column="is_deleted" property="is_deleted" />
		<result column="reg_date" property="reg_date" />
		<result column="mod_date" property="mod_date" />
	</resultMap>

	<resultMap type="DiseaseDto" id="DiseaseDto">
		<result column="no" property="no" />
		<result column="category_no" property="category_no" />
		<result column="name" property="name" />
		<result column="info" property="info" />
		<result column="good_food" property="good_food" />
		<result column="bad_food" property="bad_food" />
		<result column="bad_food" property="bad_food" />
		<result column="is_deleted" property="is_deleted" />
		<result column="reg_date" property="reg_date" />
		<result column="mod_date" property="mod_date" />
		<collection property="diseaseCategoryDto" resultMap="DiseaseCategoryDto" />
	</resultMap>
	
	<!-- 질환 카테고리 관련 -->

	<!-- 질환 카테고리 등록 -->
	<insert id="insertNewDiseaseCategory">
	
		INSERT INTO 
			DISEASE_CATEGORY 
			(NAME) 
		VALUES
			(#{name})
	
	</insert>
	
	<!-- 질환 카테고리 중복 확인 -->
	<select id="isDiseaseCategory"
			parameterType="String"
			resultType="boolean">
			
			SELECT 
				COUNT(*) 
			FROM 
				DISEASE_CATEGORY 
			WHERE 
				NAME = #{name}
	
	</select>
	
	<!-- 모든 질환 카테고리 가져오기 (질환 리스트에서 select박스 => 비동기) -->
	<select id="getDiseaseCategoryList"
			resultMap="DiseaseCategoryDto">
	
			SELECT 
				* 
			FROM 
				DISEASE_CATEGORY 
			WHERE 
				IS_DELETED = 1 
			ORDER BY 
				NO DESC
	
	</select>
	
	<!-- 모든 질환 카테고리 가져오기(페이지네이션 => 질환 카테고리 관리용 => 비동기) -->
	<select id="getDiseaseCategoryListWithPage">
	
			SELECT 
				* 
			FROM 
				DISEASE_CATEGORY 
			WHERE 
				IS_DELETED = 1 
			ORDER BY NO DESC 
			LIMIT 
				#{start}, #{limit}
	
	</select>
	
	
	<!-- 질환 카테고리의 총 리스트 개수 구하기 -->
	<select id="getAllDiseaseCategoryCnt">
	
			SELECT 
				COUNT(*) 
			FROM 
				DISEASE_CATEGORY 
			WHERE 
				IS_DELETED = 1
	
	</select>
	
	<!-- 질환 카테고리 한개 가져오기 -->
	<select id="getDiseaseCategory"
			resultMap="DiseaseCategoryDto">
			
			SELECT 
				* 
			FROM 
				DISEASE_CATEGORY 
			WHERE 
				NO = #{no} 
			
	</select>
	
	<!-- 질환 카테고리 수정 -->
	<update id="updateDiseaseCategory">
	
			UPDATE 
				DISEASE_CATEGORY 
			SET 
				NAME = #{name}, 
				MOD_DATE = NOW() 
			WHERE 
				NO = #{no}
	
	</update>
	
	<!-- 질환 카테고리 삭제 -->
	<update id="deleteDiseaseCategory">
	
		UPDATE 
			DISEASE_CATEGORY DC 
		LEFT JOIN 
			DISEASE D 
		ON 
			DC.NO = D.CATEGORY_NO 
		SET 
			DC.IS_DELETED = 0, D.IS_DELETED = 0 
		WHERE 
			DC.NO = #{no}
	
	</update>
	
	<!-- 질환  관련 -->
	
	<!-- 질환 등록 -->
	<insert id="insertNewDisease">
	
		INSERT INTO 
			DISEASE 
			(CATEGORY_NO, NAME, INFO, GOOD_FOOD, BAD_FOOD) 
		VALUES 
			(#{category_no}, #{name}, #{info}, #{good_food}, #{bad_food})
	
	</insert>
	
	<!-- 질환 중복 확인 -->
	<select id="isDisease"
			parameterType="String"
			resultType="boolean">
			
			SELECT 
				COUNT(*) 
			FROM 
				DISEASE 
			WHERE 
				NAME = #{name}
	
	</select>
	
	<!-- 모든 질환 가져오기 -->
	<select id="getDiseaseList"
			resultMap="DiseaseDto">
		
			SELECT 
				D.*, 
				DC.NAME AS DC_NAME 
			FROM 
			    DISEASE D 
			JOIN 
			    DISEASE_CATEGORY DC 
			ON 
			    D.CATEGORY_NO = DC.NO 
			WHERE 
			    D.IS_DELETED = 1 
			ORDER BY 
				NO DESC 
	
	</select>
	
	<!-- 페이지에 따른 질환 가져오기(모든 질환) -->
	<select id="getDiseaseListWithPage"
			resultMap="DiseaseDto">
			
			SELECT 
				D.*, 
				DC.NAME AS DC_NAME 
			FROM 
			    DISEASE D 
			JOIN 
			    DISEASE_CATEGORY DC 
			ON 
			    D.CATEGORY_NO = DC.NO 
			WHERE 
			    D.IS_DELETED = 1 
			ORDER BY 
				NO DESC 
			LIMIT 
				#{start}, #{limit}
	
	</select>
	
	<!-- 질환의 총 리스트 개수 구하기(모든 질환) -->
	<select id="getAllDiseaseCnt">
	
			SELECT 
				COUNT(*) 
			FROM 
				DISEASE 
			WHERE 
				IS_DELETED = 1
	
	</select>
	
	<!-- 페이지에 따른 질환 가져오기(카테고리별 질환) -->
	<select id="getDiseaseListByCategoryWithPage"
			resultMap="DiseaseDto">
			
			SELECT 
				D.*, 
				DC.NAME AS DC_NAME 
			FROM 
			    DISEASE D 
			JOIN 
			    DISEASE_CATEGORY DC 
			ON 
			    D.CATEGORY_NO = DC.NO 
			WHERE 
			    D.IS_DELETED = 1 
			AND 
				D.CATEGORY_NO = #{category_no} 
			ORDER BY 
				NO DESC 
			LIMIT 
				#{start}, #{limit}
	
	</select>
	
	<!-- 질환의 총 리스트 개수 구하기(카테고리별 질환) -->
	<select id="getDiseaseByCategoryCnt">
	
			SELECT 
				COUNT(*) 
			FROM 
				DISEASE 
			WHERE 
				IS_DELETED = 1 
			AND 
				CATEGORY_NO = #{category_no}
	
	</select>
	
	<!-- 질환 한개 가져오기 -->
	<select id="getDiseaseByNo"
			resultMap="DiseaseDto">
			
			SELECT 
				* 
			FROM 
				DISEASE 
			WHERE 
				NO = #{no}
	
	</select>
	
	<!-- 질환 수정 -->
	<update id="updateDisease">
	
			UPDATE 
				DISEASE 
			SET 
				CATEGORY_NO = #{category_no}, 
				NAME = #{name}, 
				INFO = #{info}, 
				GOOD_FOOD = #{good_food}, 
				BAD_FOOD = #{bad_food}, 
				MOD_DATE = NOW() 
			WHERE 
				NO = #{no}
	
	</update>
	
	<!-- 질환 삭제 -->
	<update id="deleteDisease">
	
			UPDATE 
				DISEASE 
			SET 
				IS_DELETED = 0 
			WHERE 
				NO = #{no}
	
	</update>
	
	<!-- 질환 검색 -->
	<select id="searchDiseaseByName"
			parameterType="String"
			resultMap="DiseaseDto">
			
			SELECT 
				* 
			FROM 
				DISEASE D  
			JOIN 
				DISEASE_CATEGORY C 
			WHERE 
				D.CATEGORY_NO = C.NO 
			AND 
				D.NAME LIKE = '%#{name}%' 
	
	</select>


</mapper>